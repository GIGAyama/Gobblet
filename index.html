
<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ãƒšãƒ¼ã‚¸ã®åŸºæœ¬çš„ãªè¨­å®š -->
  <base target="_top">
  <meta charset="UTF-8">
  <title>ã‚´ãƒ–ãƒ¬ãƒƒãƒˆ</title>
  
  <!-- ä»¥å‰ã®ã‚¢ãƒ—ãƒªã¨å…±é€šã®ã€ä¸¸ã¿ã®ã‚ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã‚’Google Fontsã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* ================================================================ */
    /* 1. åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    /* ================================================================ */

    /* :root ã¯ã€CSSå…¨ä½“ã§ä½¿ãˆã‚‹ã€Œå¤‰æ•°ã€ã‚’å®šç¾©ã™ã‚‹å ´æ‰€ã§ã™ã€‚è‰²ã®ç®¡ç†ãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ */
    :root {
      /* ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ */
      --font-family: 'M PLUS Rounded 1c', 'Hiragino Sans', 'Yu Gothic', sans-serif;
      
      /* è‰²ã®å®šç¾© */
      --bg-color: #f0e7d8;            /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®èƒŒæ™¯è‰² */
      --container-bg: #fffaf0;        /* ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰² */
      --text-color: #5d4037;          /* åŸºæœ¬ã®æ–‡å­—è‰² */
      --shadow-color: rgba(0, 0, 0, 0.15); /* å½±ã®è‰² */
      --board-bg: #a1887f;            /* ã‚²ãƒ¼ãƒ ç›¤ã®èƒŒæ™¯è‰² */
      --cell-bg: #d7ccc8;             /* ã‚²ãƒ¼ãƒ ç›¤ã®ãƒã‚¹ã®èƒŒæ™¯è‰² */
      --player1-primary: #ff8a65;     /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ */
      --player1-secondary: #ffccbc;   /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚µãƒ–ã‚«ãƒ©ãƒ¼ */
      --player2-primary: #4fc3f7;     /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆãƒ–ãƒ«ãƒ¼ç³»ï¼‰ */
      --player2-secondary: #b3e5fc;   /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ã‚µãƒ–ã‚«ãƒ©ãƒ¼ */
      --btn-bg: #4a90e2;               /* ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰² */
    }

    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬è¨­å®š */
    body {
      font-family: var(--font-family); /* ä¸Šã§å®šç¾©ã—ãŸãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
      background-color: var(--bg-color); /* ä¸Šã§å®šç¾©ã—ãŸèƒŒæ™¯è‰²ã‚’é©ç”¨ */
      display: flex;                   /* ä¸­å¤®æƒãˆã®ãŸã‚flexboxã‚’ä½¿ç”¨ */
      justify-content: center;         /* æ°´å¹³æ–¹å‘ä¸­å¤®ã«é…ç½® */
      align-items: center;             /* å‚ç›´æ–¹å‘ä¸­å¤®ã«é…ç½® */
      min-height: 100vh;               /* ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã«è¡¨ç¤º */
      margin: 0;                       /* ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ä½™ç™½ã‚’å‰Šé™¤ */
      padding: 20px;                   /* å†…å´ã®ä½™ç™½ */
      color: var(--text-color);
      box-sizing: border-box;          /* paddingã‚’å«ã‚ã¦å…¨ä½“ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®— */
      overflow: hidden;                /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«èƒŒæ™¯ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†ã« */
    }

    /* ã‚²ãƒ¼ãƒ å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #game-container {
      background-color: var(--container-bg);
      padding: 25px;
      border-radius: 20px;             /* è§’ã‚’ä¸¸ãã™ã‚‹ */
      box-shadow: 0 10px 30px var(--shadow-color); /* ç«‹ä½“çš„ã«è¦‹ã›ã‚‹å½± */
      text-align: center;
      width: 100%;
      max-width: 980px;
      transition: transform 0.5s ease, filter 0.5s ease, opacity 0.5s ease; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
    }

    /* ã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒˆãƒ« */
    .title {
      font-size: 2.5em;                /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
      font-weight: 700;                /* å¤ªå­—ã«ã™ã‚‹ */
      margin: 0 0 25px;
    }

    /* ã‚²ãƒ¼ãƒ ç›¤ã‚„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ã‚’å›²ã‚€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .main-game-area {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;                       /* å„è¦ç´ ã®é–“éš” */
      flex-wrap: nowrap;               /* æ¨ªä¸¦ã³ã§æŠ˜ã‚Šè¿”ã•ãªã„ */
    }

    /* ================================================================ */
    /* 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* ================================================================ */
    .player-area {
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      width: 280px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.5); /* æ ç·š */
      transition: transform 0.3s ease;
    }

    /* å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰²ã‚’ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¨­å®š */
    #player1-area { background: linear-gradient(135deg, var(--player1-primary), #ffa726); }
    #player2-area { background: linear-gradient(135deg, var(--player2-primary), #29b6f6); }

    .player-area h3 {
      font-size: 1.3em;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 15px;
      color: white;                    /* æ–‡å­—ã‚’ç™½ã« */
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* æ–‡å­—ã«å½±ã‚’ã¤ã‘ã¦èª­ã¿ã‚„ã™ã */
    }
    
    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚¨ãƒªã‚¢ */
    .player-hand {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      min-height: 110px;
      padding: 10px 0;
    }
    .player-hand .piece {
      position: relative; /* é§’ã®é¸æŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ */
    }
    .player-hand .piece.selected {
      transform: scale(1.1) translateY(-5px); /* é¸æŠã•ã‚ŒãŸé§’ã‚’å°‘ã—å¤§ããã€ä¸Šã«å‹•ã‹ã™ */
    }

    /* ================================================================ */
    /* 3. ã‚²ãƒ¼ãƒ ç›¤ã¨ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* ================================================================ */
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3åˆ—ã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
      grid-template-rows: repeat(3, 1fr);    /* 3è¡Œã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
      gap: 8px;
      background: linear-gradient(145deg, #bcaaa4, var(--board-bg));
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.1); /* å†…å¤–ã«å½±ã‚’ã¤ã‘ã¦ç«‹ä½“æ„Ÿã‚’å‡ºã™ */
      width: 320px;
      height: 320px;
      flex-shrink: 0; /* å°ã•ã„ç”»é¢ã§ã‚‚ç¸®ã¾ãªã„ã‚ˆã†ã« */
    }
    .cell {
      background: linear-gradient(145deg, #f5f5f5, var(--cell-bg));
      border: 1px solid #a1887f;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative; /* é§’ã‚’çµ¶å¯¾ä½ç½®ã§é…ç½®ã™ã‚‹ãŸã‚ */
      cursor: pointer;    /* ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ã‚«ãƒ¼ã‚½ãƒ« */
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .cell:hover {
      background: linear-gradient(145deg, #ffffff, #e0e0e0); /* ãƒã‚¦ã‚¹ãŒä¹—ã£ãŸã‚‰å°‘ã—æ˜ã‚‹ã */
      transform: scale(1.02); /* å°‘ã—å¤§ããã—ã¦åå¿œã‚’ç¤ºã™ */
    }

    /* ================================================================ */
    /* 4. é§’ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* ================================================================ */
    .piece {
      position: absolute; /* è¦ªè¦ç´ (.cell)ã®ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ */
      box-sizing: border-box;
      cursor: default; /* åŸºæœ¬ã¯ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã‚«ãƒ¼ã‚½ãƒ« */
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* å‹•ãã®ã‚ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .piece.selectable { cursor: grab !important; } /* é¸æŠå¯èƒ½ãªé§’ã¯æ´ã‚€ã‚«ãƒ¼ã‚½ãƒ«ã« */
    .piece.selectable:hover {
      animation: pulse 0.8s infinite ease-in-out; /* é¸æŠå¯èƒ½ãªé§’ãŒè„ˆæ‰“ã¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      filter: brightness(1.15); /* å°‘ã—æ˜ã‚‹ãã™ã‚‹ */
    }
    .piece svg {
      display: block;
      filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.4)); /* SVGã«å½±ã‚’ã¤ã‘ã‚‹ */
      transition: filter 0.3s ease;
    }
    .piece.selectable:hover svg {
      filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.5));
    }
    .piece.selected {
      animation: wobble 0.5s ease-in-out; /* é¸æŠä¸­ã®é§’ãŒæºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      filter: brightness(1.2) drop-shadow(0 0 10px yellow); /* é»„è‰²ã„å…‰ã§å¼·èª¿ */
      cursor: grabbing !important; /* æ´ã‚“ã§ã„ã‚‹ã‚«ãƒ¼ã‚½ãƒ«ã« */
      z-index: 10; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
    }
    @keyframes pulse { /* è„ˆæ‰“ã¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes wobble { /* æºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
      0%, 100% { transform: rotate(0deg) scale(1.1); }
      25% { transform: rotate(-3deg) scale(1.1); }
      50% { transform: rotate(3deg) scale(1.1); }
      75% { transform: rotate(-2deg) scale(1.1); }
    }

    /* ================================================================ */
    /* 5. ã‚²ãƒ¼ãƒ æƒ…å ±ã¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* ================================================================ */
    #game-info-area {
      margin-top: 25px;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px); /* ã™ã‚Šã‚¬ãƒ©ã‚¹åŠ¹æœ */
      border-radius: 12px;
      box-shadow: 0 4px 8px var(--shadow-color);
      text-align: center;
      min-width: 320px;
    }
    #turn-indicator {
      font-weight: 700;
      font-size: 1.2em;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.5s ease;
    }
    /* ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã®èƒŒæ™¯è‰²ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«å¤‰æ›´ */
    #turn-indicator.player1-turn { background-color: var(--player1-secondary); }
    #turn-indicator.player2-turn { background-color: var(--player2-secondary); }

    #message-area {
      margin-top: 12px;
      font-weight: 700;
      min-height: 24px; /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„æ™‚ã‚‚é«˜ã•ã‚’ç¢ºä¿ */
      font-size: 1.05em;
      transition: color 0.3s ease;
    }
    #message-area.error { color: #d32f2f !important; } /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯èµ¤è‰²ã« */
    #message-area.success { color: #388e3c !important; } /* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç·‘è‰²ã« */
    
    .btn {
      font-family: var(--font-family);
      background-color: var(--btn-bg);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .btn:hover {
      background-color: #357abd;
      transform: translateY(-2px); /* å°‘ã—ä¸Šã«å‹•ã‹ã™ */
      box-shadow: 0 6px 10px rgba(0,0,0,0.3);
    }
    .btn:active {
      transform: translateY(0); /* ã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ã«å…ƒã«æˆ»ã™ */
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #reset-button { margin-top: 15px; }


    /* ================================================================ */
    /* 6. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©) */
    /* ================================================================ */
    @media (max-width: 980px) {
      body { padding: 10px; }
      #game-container { padding: 15px; }
      .main-game-area {
        flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
        align-items: center;
      }
    }

    /* ================================================================ */
    /* 7. å‹åˆ©æ¼”å‡ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ« */
    /* ================================================================ */
    .modal {
        position: fixed; /* ç”»é¢ã«å›ºå®š */
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5); /* åŠé€æ˜ã®é»’ã„èƒŒæ™¯ */
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
    }
    /* ç´™å¹é›ªã‚’æç”»ã™ã‚‹ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #confetti-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1001; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šã¯å¾Œã‚ */
    }
    .modal-content {
        position: relative;
        z-index: 1002; /* ç´™å¹é›ªã‚ˆã‚Šæ‰‹å‰ */
        background-color: var(--container-bg);
        padding: 40px 60px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: slide-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    }
    #winner-message {
        font-size: 2.8em;
        font-weight: 700;
        margin: 0 0 30px;
        color: var(--text-color);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    #winner-message ruby rt { /* ãƒ«ãƒ“ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
      font-size: 0.5em;
    }
    #close-modal-btn {
      font-size: 1.2em;
      padding: 12px 25px;
    }

    @keyframes slide-in {
      from { transform: translateY(-50px) scale(0.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- ======================= HTMLæ§‹é€  ======================== -->
  <!-- ã‚²ãƒ¼ãƒ å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="game-container">
    <h1 class="title">ã‚´ãƒ–ãƒ¬ãƒƒãƒˆ</h1>
    
    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ã¨ã‚²ãƒ¼ãƒ ç›¤ã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="main-game-area">
      <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚¨ãƒªã‚¢ -->
      <div id="player1-area" class="player-area">
        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®<ruby>é§’<rt>ã“ã¾</rt></ruby></h3>
        <div id="p1-hand" class="player-hand"></div>
      </div>
      
      <!-- ã‚²ãƒ¼ãƒ ç›¤ -->
      <div id="board" class="board"></div>

      <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ã‚¨ãƒªã‚¢ -->
      <div id="player2-area" class="player-area">
        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®<ruby>é§’<rt>ã“ã¾</rt></ruby></h3>
        <div id="p2-hand" class="player-hand"></div>
      </div>
    </div>

    <!-- ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹æƒ…å ±ã‚¨ãƒªã‚¢ -->
    <div id="game-info-area">
      <div id="turn-indicator"></div>
      <div id="message-area"></div>
      <button id="reset-button" class="btn">ã‚‚ã†<ruby>ä¸€<rt>ã„ã¡</rt>åº¦<rt>ã©</rt></ruby>ï¼</button>
    </div>
  </div>

  <!-- å‹åˆ©è€…è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
  <div id="winner-modal" class="modal">
      <canvas id="confetti-canvas"></canvas>
      <div class="modal-content">
          <h2 id="winner-message"></h2>
          <button id="close-modal-btn" class="btn"><ruby>é–‰<rt>ã¨</rt></ruby>ã˜ã‚‹</button>
      </div>
  </div>


<script>
// ================================================================
// 1. ã‚²ãƒ¼ãƒ å…¨ä½“ã§ä½¿ã†è¨­å®šã¨çŠ¶æ…‹
// ================================================================

/**
 * @description ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªè¨­å®šã‚’ã¾ã¨ã‚ãŸå®šæ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 * ã“ã‚Œã‚‰ã®å€¤ã¯ã‚²ãƒ¼ãƒ ä¸­ã«å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚
 */
const GAME_CONSTANTS = {
  BOARD_SIZE: 3, // ãƒœãƒ¼ãƒ‰ã®ä¸€è¾ºã®ãƒã‚¹æ•° (3x3)
  PLAYERS: { P1: 'orange', P2: 'blue' }, // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®å†…éƒ¨å
  SIZES: { SMALL: 'small', MEDIUM: 'medium', LARGE: 'large' }, // é§’ã®ã‚µã‚¤ã‚º
  // é§’ã®ã‚µã‚¤ã‚ºã®é †åºã‚’å®šç¾©ã€‚ã“ã®é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¤§ãã„ã»ã©ã€é§’ãŒå¤§ãã„ã“ã¨ã‚’ç¤ºã™ã€‚
  SIZE_ORDER: ['small', 'medium', 'large'],
};

/**
 * @description HTMLã®å„è¦ç´ ã¸ã®å‚ç…§ã‚’ã¾ã¨ã‚ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 * èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘å–å¾—ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’é«˜ã‚ã€ä½•åº¦ã‚‚åŒã˜è¦ç´ ã‚’æ¤œç´¢ã™ã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚
 */
const DOM_ELEMENTS = {
  gameContainer: document.getElementById('game-container'),
  board: document.getElementById('board'),
  player1Hand: document.getElementById('p1-hand'),
  player2Hand: document.getElementById('p2-hand'),
  turnIndicator: document.getElementById('turn-indicator'),
  messageArea: document.getElementById('message-area'),
  resetButton: document.getElementById('reset-button'),
  winnerModal: document.getElementById('winner-modal'),
  winnerMessage: document.getElementById('winner-message'),
  closeModalBtn: document.getElementById('close-modal-btn'),
  confettiCanvas: document.getElementById('confetti-canvas'),
};

/**
 * @description ã‚²ãƒ¼ãƒ ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 * ã‚²ãƒ¼ãƒ ã®é€²è¡Œã«å¿œã˜ã¦ã€ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãã¾ã™ã€‚
 */
let gameState = {
  board: [],       // ç›¤é¢ã®çŠ¶æ…‹ã‚’è¡¨ã™2æ¬¡å…ƒé…åˆ—ã€‚å„ãƒã‚¹ã«ã¯é§’ã®ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆé…åˆ—ï¼‰ãŒå…¥ã‚‹ã€‚
  playerHands: {}, // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã®çŠ¶æ…‹ã€‚
  currentPlayer: null, // ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€‚
  selectedPiece: null, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠä¸­ã®é§’ã®æƒ…å ±ã€‚
  isGameOver: false,   // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã€‚
  messageTimeoutId: null, // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•ã§æ¶ˆã™ãŸã‚ã®ã‚¿ã‚¤ãƒãƒ¼IDã€‚
};


// ================================================================
// 2. ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨ãƒªã‚»ãƒƒãƒˆ
// ================================================================

/**
 * @description ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã¨ãã€ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«ã‚²ãƒ¼ãƒ å…¨ä½“ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°ã€‚
 */
function initializeGame() {
  confettiModule.stop();
  DOM_ELEMENTS.winnerModal.style.display = 'none';

  resetGameState();
  resetGameUI();
  setupInitialEventListeners();
  
  updateTurnIndicator();
  displayMessage(""); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
  updatePieceSelectability();
}

/**
 * @description ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
 */
function resetGameState() {
  gameState.board = Array(GAME_CONSTANTS.BOARD_SIZE).fill(null).map(() => 
    Array(GAME_CONSTANTS.BOARD_SIZE).fill(null).map(() => [])
  );
  gameState.playerHands = {
    [GAME_CONSTANTS.PLAYERS.P1]: createInitialHand(),
    [GAME_CONSTANTS.PLAYERS.P2]: createInitialHand(),
  };
  gameState.currentPlayer = GAME_CONSTANTS.PLAYERS.P1;
  gameState.selectedPiece = null;
  gameState.isGameOver = false;
}

/**
 * @description å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸæ‰‹æœ­ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 * @returns {Array<object>} å„ã‚µã‚¤ã‚º2å€‹ãšã¤ã®é§’ã‚’æŒã¤æ‰‹æœ­ã®é…åˆ—ã€‚
 */
function createInitialHand() {
  const hand = [];
  GAME_CONSTANTS.SIZE_ORDER.forEach(size => {
    hand.push({ size: size }, { size: size }); // å„ã‚µã‚¤ã‚º2å€‹ãšã¤
  });
  return hand;
}

/**
 * @description ã‚²ãƒ¼ãƒ ã®UIï¼ˆè¦‹ãŸç›®ï¼‰ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã€å†æç”»ã—ã¾ã™ã€‚
 */
function resetGameUI() {
  DOM_ELEMENTS.board.innerHTML = '';
  DOM_ELEMENTS.player1Hand.innerHTML = '';
  DOM_ELEMENTS.player2Hand.innerHTML = '';
  
  // ãƒœãƒ¼ãƒ‰ã®ãƒã‚¹ã‚’ä½œæˆ
  for (let r = 0; r < GAME_CONSTANTS.BOARD_SIZE; r++) {
    for (let c = 0; c < GAME_CONSTANTS.BOARD_SIZE; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.row = r;
      cell.dataset.col = c;
      DOM_ELEMENTS.board.appendChild(cell);
    }
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’æç”»
  renderPlayerHand(GAME_CONSTANTS.PLAYERS.P1);
  renderPlayerHand(GAME_CONSTANTS.PLAYERS.P2);
}


// ================================================================
// 3. æç”»é–¢é€£ã®é–¢æ•°
// ================================================================

/**
 * @description æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’ç”»é¢ã«æç”»ã—ã¾ã™ã€‚
 * @param {string} player - æç”»ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (e.g., 'orange')
 */
function renderPlayerHand(player) {
  const handElement = (player === GAME_CONSTANTS.PLAYERS.P1) ? DOM_ELEMENTS.player1Hand : DOM_ELEMENTS.player2Hand;
  handElement.innerHTML = ''; // ä¸€æ—¦ç©ºã«ã™ã‚‹

  const hand = gameState.playerHands[player];
  hand.forEach((pieceData, index) => {
    const pieceElement = createPieceElement(player, pieceData.size);
    // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ã€ã©ã®é§’ã‹è­˜åˆ¥ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’æ ¼ç´
    pieceElement.dataset.player = player;
    pieceElement.dataset.size = pieceData.size;
    pieceElement.dataset.source = 'hand';
    pieceElement.dataset.handIndex = index;
    handElement.appendChild(pieceElement);
  });
}

/**
 * @description æŒ‡å®šã•ã‚ŒãŸãƒã‚¹ã«ã‚ã‚‹ä¸€ç•ªä¸Šã®é§’ã‚’æç”»ã—ã¾ã™ã€‚
 * @param {number} row - ãƒã‚¹ã®è¡Œç•ªå· (0-2)
 * @param {number} col - ãƒã‚¹ã®åˆ—ç•ªå· (0-2)
 */
function renderCellPiece(row, col) {
  const cellElement = DOM_ELEMENTS.board.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
  if (!cellElement) return;
  cellElement.innerHTML = ''; // æ—¢å­˜ã®é§’ã‚’ã‚¯ãƒªã‚¢

  const cellStack = gameState.board[row][col];
  if (cellStack.length > 0) {
    const topPieceData = cellStack[cellStack.length - 1];
    const pieceElement = createPieceElement(topPieceData.player, topPieceData.size);
    // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ã€ã©ã®é§’ã‹è­˜åˆ¥ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’æ ¼ç´
    pieceElement.dataset.player = topPieceData.player;
    pieceElement.dataset.size = topPieceData.size;
    pieceElement.dataset.source = 'board';
    pieceElement.dataset.row = row;
    pieceElement.dataset.col = col;
    cellElement.appendChild(pieceElement);
  }
}

/**
 * @description é§’ã®SVGè¦ç´ ã‚’ç”Ÿæˆã—ã¾ã™ã€‚é§’ã®è¦‹ãŸç›®ã¯ã“ã“ã§ä½œã‚‰ã‚Œã¾ã™ã€‚
 * @param {string} player - é§’ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
 * @param {string} size - é§’ã®ã‚µã‚¤ã‚º ('small', 'medium', 'large')
 * @returns {HTMLElement} ç”Ÿæˆã•ã‚ŒãŸé§’ã®divè¦ç´ 
 */
function createPieceElement(player, size) {
  const pieceWrapper = document.createElement('div');
  pieceWrapper.className = `piece piece-${size}`;

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  let width, height, viewBox, bodyPath, eyePath;
  const color = (player === GAME_CONSTANTS.PLAYERS.P1) ? 'var(--player1-primary)' : 'var(--player2-primary)';
  const strokeColor = '#424242';

  // ã‚µã‚¤ã‚ºã«å¿œã˜ã¦SVGã®å½¢çŠ¶ã‚’æ±ºå®š
  switch (size) {
    case GAME_CONSTANTS.SIZES.LARGE:
      width = 80; height = 80; viewBox = "0 0 50 50";
      bodyPath = "M5,45 C5,20 15,5 25,5 C35,5 45,20 45,45 Z";
      eyePath = "M18,25 a3,3 0 1,1 0,0.1 Z M32,25 a3,3 0 1,1 0,0.1 Z";
      break;
    case GAME_CONSTANTS.SIZES.MEDIUM:
      width = 60; height = 60; viewBox = "0 0 40 40";
      bodyPath = "M8,35 C8,15 15,5 20,5 C25,5 32,15 32,35 Z";
      eyePath = "M20,20 a3,3 0 1,1 0,0.1 Z";
      break;
    case GAME_CONSTANTS.SIZES.SMALL:
    default:
      width = 40; height = 40; viewBox = "0 0 30 30";
      bodyPath = "M10,25 C10,10 12,5 15,5 C18,5 20,10 20,25 Z";
      eyePath = ""; // å°ã•ã„é§’ã«ã¯ç›®ãŒãªã„
      break;
  }
  
  svg.setAttribute("width", width);
  svg.setAttribute("height", height);
  svg.setAttribute("viewBox", viewBox);
  
  const body = document.createElementNS(svgNS, "path");
  body.setAttribute("d", bodyPath);
  body.setAttribute("fill", color);
  body.setAttribute("stroke", strokeColor);
  body.setAttribute("stroke-width", "1.5");
  svg.appendChild(body);

  if(eyePath){
    const eyes = document.createElementNS(svgNS, "path");
    eyes.setAttribute("d", eyePath);
    eyes.setAttribute("fill", strokeColor);
    svg.appendChild(eyes);
  }
  
  pieceWrapper.appendChild(svg);
  return pieceWrapper;
}


// ================================================================
// 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰
// ================================================================

/**
 * @description ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã‚„ãƒªã‚»ãƒƒãƒˆæ™‚ã«ã€ä¸»è¦ãªè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
 */
function setupInitialEventListeners() {
  DOM_ELEMENTS.resetButton.addEventListener('click', initializeGame);
  DOM_ELEMENTS.closeModalBtn.addEventListener('click', () => {
    DOM_ELEMENTS.winnerModal.style.display = 'none';
    confettiModule.stop();
  });
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šãƒœãƒ¼ãƒ‰å…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¡å—ã‘ã‚‹
  DOM_ELEMENTS.board.addEventListener('click', handleBoardClick);

  // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚¨ãƒªã‚¢ã§ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¡å—ã‘ã‚‹
  DOM_ELEMENTS.player1Hand.addEventListener('click', handleHandClick);
  DOM_ELEMENTS.player2Hand.addEventListener('click', handleHandClick);
}

/**
 * @description æ‰‹æœ­ã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã€‚ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’åˆ©ç”¨ã€‚
 * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
 */
function handleHandClick(event) {
  const pieceElement = event.target.closest('.piece');
  if (pieceElement) {
    handlePieceClick(pieceElement);
  }
}

/**
 * @description ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã€‚ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’åˆ©ç”¨ã€‚
 * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
 */
function handleBoardClick(event) {
  const targetElement = event.target;
  const pieceElement = targetElement.closest('.piece');
  const cellElement = targetElement.closest('.cell');

  if (pieceElement) { // é§’ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
    handlePieceClick(pieceElement);
  } else if (cellElement) { // ã‚»ãƒ«ï¼ˆä½•ã‚‚ãªã„å ´æ‰€ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
    handleCellClick(cellElement);
  }
}

/**
 * @description é§’ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã€‚
 * @param {HTMLElement} pieceElement - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸé§’ã®è¦ç´ 
 */
function handlePieceClick(pieceElement) {
  if (gameState.isGameOver) return;

  const { player, size, source, handIndex, row, col } = pieceElement.dataset;

  // ç›¸æ‰‹ã®é§’ã¯é¸æŠã§ããªã„
  if (player !== gameState.currentPlayer) {
    displayMessage("<ruby>ç›¸æ‰‹<rt>ã‚ã„ã¦</rt></ruby>ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚", 'error');
    return;
  }
  
  // ã™ã§ã«é¸æŠä¸­ã®åŒã˜é§’ã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã€é¸æŠè§£é™¤
  if (gameState.selectedPiece && gameState.selectedPiece.element === pieceElement) {
    deselectPiece();
    return;
  }

  // æ–°ã—ã„é§’ã‚’é¸æŠ
  const pieceInfo = {
    element: pieceElement,
    player,
    size,
    source, // 'hand' or 'board'
    // sourceã«å¿œã˜ã¦å…ƒã®ä½ç½®æƒ…å ±ã‚’æ ¼ç´
    ...(source === 'hand' ? { handIndex: parseInt(handIndex) } : { row: parseInt(row), col: parseInt(col) })
  };
  selectPiece(pieceInfo);
}

/**
 * @description ã‚»ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã€‚
 * @param {HTMLElement} cellElement - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚»ãƒ«ã®è¦ç´ 
 */
function handleCellClick(cellElement) {
  if (gameState.isGameOver || !gameState.selectedPiece) return;

  const targetRow = parseInt(cellElement.dataset.row);
  const targetCol = parseInt(cellElement.dataset.col);

  // é§’ã®ç§»å‹•ã‚’è©¦ã¿ã‚‹
  if (tryMovePiece(targetRow, targetCol)) {
    // ç§»å‹•ã«æˆåŠŸã—ãŸã‚‰ã€å¾Œå‡¦ç†
    if (gameState.selectedPiece.source === 'board') {
      // å…ƒã®ç›¤ä¸Šã®ãƒã‚¹ã‚’å†æç”»ï¼ˆé§’ãŒç§»å‹•ã—ã¦ç©ºã«ãªã‚‹ã‹ã€ä¸‹ã®é§’ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
      renderCellPiece(gameState.selectedPiece.row, gameState.selectedPiece.col);
    }
    
    // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤ã—ã€UIã‚’æ›´æ–°
    deselectPiece();
    renderCellPiece(targetRow, targetCol); // ç§»å‹•å…ˆã®ãƒã‚¹ã‚’å†æç”»
    renderPlayerHand(gameState.currentPlayer); // æ‰‹æœ­ãŒæ¸›ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å†æç”»
    
    // å‹æ•—ã‚’ãƒã‚§ãƒƒã‚¯
    const winner = checkWinCondition();
    if (winner) {
      endGame(winner);
    } else {
      switchTurn();
    }
  }
}


// ================================================================
// 5. ã‚²ãƒ¼ãƒ ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
// ================================================================

/**
 * @description é§’ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¾ã™ã€‚
 * @param {object} pieceInfo - é¸æŠã™ã‚‹é§’ã®æƒ…å ±
 */
function selectPiece(pieceInfo) {
  deselectPiece(); // ã™ã§ã«é¸æŠä¸­ã®ã‚‚ã®ãŒã‚ã‚Œã°è§£é™¤
  gameState.selectedPiece = pieceInfo;
  pieceInfo.element.classList.add('selected');
  displayMessage("<ruby>é…ç½®å…ˆ<rt>ã¯ã„ã¡ã•ã</rt></ruby>ã®ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚");
}

/**
 * @description é§’ã®é¸æŠã‚’è§£é™¤ã—ã¾ã™ã€‚
 */
function deselectPiece() {
  if (gameState.selectedPiece) {
    gameState.selectedPiece.element.classList.remove('selected');
    gameState.selectedPiece = null;
  }
}

/**
 * @description é¸æŠä¸­ã®é§’ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¹ã¸ç§»å‹•ã•ã›ã‚‹å‡¦ç†ã€‚
 * @param {number} targetRow - ç§»å‹•å…ˆã®è¡Œ
 * @param {number} targetCol - ç§»å‹•å…ˆã®åˆ—
 * @returns {boolean} ç§»å‹•ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹
 */
function tryMovePiece(targetRow, targetCol) {
  if (!gameState.selectedPiece) return false;

  const targetCellStack = gameState.board[targetRow][targetCol];
  const topPieceOnTarget = targetCellStack.length > 0 ? targetCellStack[targetCellStack.length - 1] : null;

  // ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼šç§»å‹•å…ˆã«è‡ªåˆ†ã‚ˆã‚Šå¤§ãã„ã‹åŒã˜ã‚µã‚¤ã‚ºã®é§’ãŒã‚ã‚‹å ´åˆã¯ç½®ã‘ãªã„
  if (topPieceOnTarget) {
    const selectedSizeIndex = GAME_CONSTANTS.SIZE_ORDER.indexOf(gameState.selectedPiece.size);
    const targetSizeIndex = GAME_CONSTANTS.SIZE_ORDER.indexOf(topPieceOnTarget.size);
    if (selectedSizeIndex <= targetSizeIndex) {
      displayMessage("ã‚ˆã‚Š<ruby>å°<rt>ã¡ã„</rt></ruby>ã•ã„<ruby>é§’<rt>ã“ã¾</rt></ruby>ã®<ruby>ä¸Š<rt>ã†ãˆ</rt></ruby>ã«ã¯<ruby>ç½®<rt>ãŠ</rt></ruby>ã‘ã¾ã›ã‚“ã€‚", 'error');
      return false;
    }
  }

  // é§’ã‚’å…ƒã®å ´æ‰€ã‹ã‚‰å–ã‚Šé™¤ã
  const pieceData = { player: gameState.selectedPiece.player, size: gameState.selectedPiece.size };
  if (gameState.selectedPiece.source === 'hand') {
    // æ‰‹æœ­ã‹ã‚‰å–ã‚Šé™¤ã
    gameState.playerHands[pieceData.player].splice(gameState.selectedPiece.handIndex, 1);
  } else {
    // ç›¤ä¸Šã‹ã‚‰å–ã‚Šé™¤ã
    gameState.board[gameState.selectedPiece.row][gameState.selectedPiece.col].pop();
  }

  // é§’ã‚’æ–°ã—ã„å ´æ‰€ã«ç½®ã
  gameState.board[targetRow][targetCol].push(pieceData);
  
  return true;
}

/**
 * @description ã‚¿ãƒ¼ãƒ³ã‚’äº¤ä»£ã—ã¾ã™ã€‚
 */
function switchTurn() {
  gameState.currentPlayer = (gameState.currentPlayer === GAME_CONSTANTS.PLAYERS.P1) ? GAME_CONSTANTS.PLAYERS.P2 : GAME_CONSTANTS.PLAYERS.P1;
  deselectPiece();
  updateTurnIndicator();
  displayMessage(""); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
  updatePieceSelectability();
}

/**
 * @description ç¾åœ¨ã®ç›¤é¢ã§å‹è€…ãŒã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
 * @returns {string|null} å‹è€…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã€ã¾ãŸã¯å‹è€…ãŒã„ãªã‘ã‚Œã°null
 */
function checkWinCondition() {
  const getTopPiece = (r, c) => {
    const stack = gameState.board[r][c];
    return stack.length > 0 ? stack[stack.length - 1] : null;
  };
  
  const checkLine = (line) => {
    const firstPiece = line[0];
    if (!firstPiece) return null; // æœ€åˆã®ãƒã‚¹ãŒç©ºãªã‚‰æƒã£ã¦ã„ãªã„
    // 3ãƒã‚¹å…¨ã¦ãŒåŒã˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é§’ã‹ãƒã‚§ãƒƒã‚¯
    if (line.every(piece => piece && piece.player === firstPiece.player)) {
      return firstPiece.player;
    }
    return null;
  };
  
  let winner = null;
  // æ¨ªãƒ©ã‚¤ãƒ³ã®ãƒã‚§ãƒƒã‚¯
  for (let r = 0; r < GAME_CONSTANTS.BOARD_SIZE; r++) {
    winner = checkLine([getTopPiece(r, 0), getTopPiece(r, 1), getTopPiece(r, 2)]);
    if (winner) return winner;
  }
  // ç¸¦ãƒ©ã‚¤ãƒ³ã®ãƒã‚§ãƒƒã‚¯
  for (let c = 0; c < GAME_CONSTANTS.BOARD_SIZE; c++) {
    winner = checkLine([getTopPiece(0, c), getTopPiece(1, c), getTopPiece(2, c)]);
    if (winner) return winner;
  }
  // æ–œã‚ãƒ©ã‚¤ãƒ³ï¼ˆå·¦ä¸Šã‹ã‚‰å³ä¸‹ï¼‰ã®ãƒã‚§ãƒƒã‚¯
  winner = checkLine([getTopPiece(0, 0), getTopPiece(1, 1), getTopPiece(2, 2)]);
  if (winner) return winner;
  
  // æ–œã‚ãƒ©ã‚¤ãƒ³ï¼ˆå³ä¸Šã‹ã‚‰å·¦ä¸‹ï¼‰ã®ãƒã‚§ãƒƒã‚¯
  winner = checkLine([getTopPiece(0, 2), getTopPiece(1, 1), getTopPiece(2, 0)]);
  if (winner) return winner;

  return null;
}

/**
 * @description ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã•ã›ã€å‹åˆ©æ¼”å‡ºã‚’é–‹å§‹ã—ã¾ã™ã€‚
 * @param {string} winner - å‹è€…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
 */
function endGame(winner) {
    gameState.isGameOver = true;
    updatePieceSelectability(); // å…¨ã¦ã®é§’ã‚’é¸æŠä¸å¯ã«ã™ã‚‹
    const winnerName = winner === GAME_CONSTANTS.PLAYERS.P1 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
    DOM_ELEMENTS.winnerMessage.innerHTML = `ğŸ‰ ${winnerName} ã®<ruby>å‹åˆ©<rt>ã—ã‚‡ã†ã‚Š</rt></ruby>ï¼ ğŸ‰`;
    DOM_ELEMENTS.winnerModal.style.display = 'flex';
    confettiModule.start();
}


// ================================================================
// 6. UIæ›´æ–°ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ================================================================

/**
 * @description ç”»é¢ä¸Šã®ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
 */
function updateTurnIndicator() {
  const playerName = gameState.currentPlayer === GAME_CONSTANTS.PLAYERS.P1 ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
  DOM_ELEMENTS.turnIndicator.innerHTML = `<ruby>ç¾åœ¨<rt>ã’ã‚“ã–ã„</rt></ruby>ã®ã‚¿ãƒ¼ãƒ³: ${playerName}`;
  DOM_ELEMENTS.turnIndicator.className = 'turn-indicator'; // ã‚¯ãƒ©ã‚¹ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
  const turnClass = gameState.currentPlayer === GAME_CONSTANTS.PLAYERS.P1 ? 'player1-turn' : 'player2-turn';
  DOM_ELEMENTS.turnIndicator.classList.add(turnClass);
}

/**
 * @description ç”»é¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚4ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã¾ã™ã€‚
 * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆHTMLå¯ï¼‰
 * @param {string} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ ('error' or 'success')
 */
function displayMessage(msg, type = '') {
  DOM_ELEMENTS.messageArea.innerHTML = msg;
  DOM_ELEMENTS.messageArea.className = 'message-area'; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
  if (type) DOM_ELEMENTS.messageArea.classList.add(type);

  // å‰å›ã®ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°ã‚¯ãƒªã‚¢
  if (gameState.messageTimeoutId) clearTimeout(gameState.messageTimeoutId);
  
  if (msg) {
    // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€4ç§’å¾Œã«æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ
    gameState.messageTimeoutId = setTimeout(() => {
      DOM_ELEMENTS.messageArea.innerHTML = '';
      DOM_ELEMENTS.messageArea.className = 'message-area';
    }, 4000);
  }
}

/**
 * @description ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ“ä½œã§ãã‚‹é§’ã« 'selectable' ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘å¤–ã—ã—ã¾ã™ã€‚
 */
function updatePieceSelectability() {
  document.querySelectorAll('.piece').forEach(piece => {
    piece.classList.remove('selectable'); // ã¾ãšå…¨é§’ã‚’é¸æŠä¸å¯ã«
    if (gameState.isGameOver) return; // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã¯ä½•ã‚‚ã—ãªã„

    const player = piece.dataset.player;
    // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã€ã‹ã¤ç›¤ä¸Šã®ä¸€ç•ªä¸Šã®é§’ã€ã¾ãŸã¯æ‰‹æœ­ã®é§’ãªã‚‰é¸æŠå¯èƒ½
    if (player === gameState.currentPlayer) {
      if (piece.dataset.source === 'hand') {
        piece.classList.add('selectable');
      } else {
        const r = parseInt(piece.dataset.row);
        const c = parseInt(piece.dataset.col);
        const stack = gameState.board[r][c];
        if (stack.length > 0 && stack[stack.length - 1].size === piece.dataset.size) {
          piece.classList.add('selectable');
        }
      }
    }
  });
}


// ================================================================
// 7. ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
// ================================================================

/**
 * @description ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ã®æ©Ÿèƒ½ã‚’ã¾ã¨ã‚ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚
 */
const confettiModule = {
  animationId: null,
  particles: [],
  colors: ["#ff8a65", "#4fc3f7", "#ffd54f", "#81c784", "#ff80ab", "#9575cd"],
  ctx: null,

  /** @description ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚ */
  start() {
    this.ctx = DOM_ELEMENTS.confettiCanvas.getContext('2d');
    const canvas = DOM_ELEMENTS.confettiCanvas;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    this.particles = Array.from({ length: 150 }, () => this.createParticle(canvas));
    this.animate();
  },

  /** @description ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã€‚ */
  stop() {
    cancelAnimationFrame(this.animationId);
    if (this.ctx) {
      this.ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    }
  },

  /** @description 1ã¤ã®ç´™å¹é›ªã®ç²’ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ */
  createParticle(canvas) {
    return {
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height, // ç”»é¢ã®ä¸Šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        size: Math.random() * 10 + 5,
        color: this.colors[Math.floor(Math.random() * this.colors.length)],
        speed: Math.random() * 3 + 2,
        angle: Math.random() * Math.PI * 2,
        spin: (Math.random() - 0.5) * 0.2
    };
  },

  /** @description ç´™å¹é›ªã‚’å‹•ã‹ã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã€‚ */
  animate() {
    const canvas = DOM_ELEMENTS.confettiCanvas;
    this.ctx.clearRect(0, 0, canvas.width, canvas.height);
    this.particles.forEach((p, i) => {
        p.y += p.speed;
        p.x += Math.sin(p.angle);
        p.angle += p.spin;
        this.ctx.fillStyle = p.color;
        this.ctx.save();
        this.ctx.translate(p.x, p.y);
        this.ctx.rotate(p.angle);
        this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
        this.ctx.restore();
        // ç²’ãŒç”»é¢å¤–ã«å‡ºãŸã‚‰ã€æ–°ã—ã„ç²’ã‚’ç”Ÿæˆã—ã¦ä¸Šã‹ã‚‰è½ã¨ã™
        if (p.y > canvas.height) {
            this.particles[i] = this.createParticle(canvas);
            this.particles[i].y = -10;
        }
    });
    this.animationId = requestAnimationFrame(() => this.animate());
  }
};


// ================================================================
// 8. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
// ================================================================

// HTMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã€ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚
document.addEventListener('DOMContentLoaded', initializeGame);

</script>
</body>
</html>
